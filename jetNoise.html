<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Jet Noise Spectrum Calculator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    margin: 20px;
}
.container {
    max-width: 1200px;
    margin: auto;
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}
h1 {
    text-align: center;
    margin-bottom: 5px;
    color: #333;
}
.subtitle {
    text-align: center;
    color: #555;
    font-size: 14px;
    margin-bottom: 25px;
}
#chartContainer1 {
    height: 400px;
    margin-bottom: 20px;
}
#chartContainer2 {
    height: 400px;
    margin-bottom: 30px;
}
.slider-group {
    margin-top: 18px;
    padding: 12px;
    background: #fafafa;
    border-radius: 5px;
}
.slider-label {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
}
.slider-value {
    font-weight: bold;
    color: #cc5500;
}
input[type="range"] {
    width: 100%;
}
.info-box {
    margin-top: 20px;
    padding: 15px;
    background: #fff5e6;
    border-left: 4px solid #cc5500;
    border-radius: 4px;
}
.info-box h3 {
    margin-top: 0;
    color: #cc5500;
}
.params-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    font-size: 13px;
}
</style>
</head>
<body>
<div class="container">
<h1>Jet Noise Spectrum Calculator</h1>
<div class="subtitle">Turbulent Mixing Noise - k-ε Model</div>

<div id="chartContainer1">
<canvas id="spectrumChart"></canvas>
</div>

<div id="chartContainer2">
<canvas id="splChart"></canvas>
</div>

<!-- Sliders -->
<div class="slider-group">
    <div class="slider-label">
        <span>Jet Diameter D [m]</span>
        <span class="slider-value" id="valD">0.50</span>
    </div>
    <input type="range" id="sliderD" min="0.1" max="2.0" step="0.05" value="0.5">
</div>

<div class="slider-group">
    <div class="slider-label">
        <span>Jet Mach Number M</span>
        <span class="slider-value" id="valM">0.80</span>
    </div>
    <input type="range" id="sliderM" min="0.3" max="2.0" step="0.05" value="0.8">
</div>

<div class="slider-group">
    <div class="slider-label">
        <span>Observer Distance x [m]</span>
        <span class="slider-value" id="valX">10.0</span>
    </div>
    <input type="range" id="sliderX" min="1" max="50" step="1" value="10">
</div>

<div class="slider-group">
    <div class="slider-label">
        <span>Correlation Magnitude A</span>
        <span class="slider-value" id="valA">1.00</span>
    </div>
    <input type="range" id="sliderA" min="0.1" max="3.0" step="0.1" value="1.0">
</div>

<div class="info-box">
    <h3>Calculated Parameters</h3>
    <div class="params-grid">
        <div><strong>u₀:</strong> <span id="u0Value">-</span> m/s</div>
        <div><strong>τ₀:</strong> <span id="tau0Value">-</span> s</div>
        <div><strong>ω₀:</strong> <span id="omega0Value">-</span> rad/s</div>
        <div><strong>l₀:</strong> <span id="l0Value">-</span> m</div>
        <div><strong>ρ₀:</strong> 1.225 kg/m³</div>
        <div><strong>c∞:</strong> 343 m/s</div>
    </div>
    <p style="margin-top:10px; font-size:12px; color:#666;">
        <strong>Formula:</strong> S(x,ω) = A² / (32πρ∞c∞²x²) ∫ ρ₀²u₀⁴l₀³ω₀³ (ω/ω₀)⁴ exp(-ω²/4ω₀²) dy₁<br>
        <strong>Note:</strong> k and ε automatically estimated from jet conditions
    </p>
</div>

</div>

<script>
// Fixed constants
const rho_inf = 1.225;
const c_inf = 343.0;
const c_tau = 0.15;

// Generate frequency array
function logspace(start, stop, n) {
    const ls = Math.log10(start);
    const le = Math.log10(stop);
    return Array.from({length: n}, (_, i) =>
        Math.pow(10, ls + (le - ls) * i / (n - 1))
    );
}

const frequencies = logspace(10, 10000, 200);

// Calculate Strouhal number
function calculateStrouhal(frequencies, D, M) {
    const U = M * c_inf;
    return frequencies.map(f => (f * D) / U);
}

// Estimate turbulence parameters from jet conditions
function estimateTurbulenceParams(D, M) {
    const U = M * c_inf;
    const turbulence_intensity = 0.02 + 0.01 * M;
    const k = 1.5 * Math.pow(turbulence_intensity * U, 2);
    const L = 0.1 * D;
    const epsilon = Math.pow(k, 1.5) / L;
    return { k, epsilon };
}

// Calculate turbulence parameters
function calculateTurbulenceParams(k, epsilon) {
    const u0 = Math.sqrt(2 * k / 3);
    const tau0 = c_tau * k / epsilon;
    const omega0 = 2 * Math.PI / tau0;
    const l0 = 1.5 * Math.pow(k, 1.5) / epsilon;
    return { u0, tau0, omega0, l0 };
}

// Calculate jet noise spectrum
function calculateSpectrum(D, M, x, A) {
    const turbParams = estimateTurbulenceParams(D, M);
    const k = turbParams.k;
    const epsilon = turbParams.epsilon;
    
    const params = calculateTurbulenceParams(k, epsilon);
    const { u0, tau0, omega0, l0 } = params;
    
    const rho0 = rho_inf;
    const V_source = Math.pow(D, 3);
    
    const spectrum = [];
    
    for (let i = 0; i < frequencies.length; i++) {
        const f = frequencies[i];
        const omega = 2 * Math.PI * f;
        
        const prefactor = (A * A) / (32 * Math.PI * rho_inf * c_inf * c_inf * x * x);
        const source_term = rho0 * rho0 * Math.pow(u0, 4) * Math.pow(l0, 3) * Math.pow(omega0, 3);
        const freq_term = Math.pow(omega / omega0, 4) * Math.exp(-omega * omega / (4 * omega0 * omega0));
        const S_omega = prefactor * source_term * freq_term * V_source;
        
        spectrum.push(S_omega);
    }
    
    return { spectrum, params, k, epsilon };
}

// Convert spectrum to SPL
function spectrumToSPL(spectrum, frequencies) {
    const p_ref = 20e-6;
    const SPL = [];
    
    for (let i = 0; i < spectrum.length; i++) {
        const df = i < frequencies.length - 1 ? 
                   frequencies[i + 1] - frequencies[i] : 
                   frequencies[i] - frequencies[i - 1];
        const p2 = spectrum[i] * df;
        
        if (p2 > 0) {
            SPL.push(10 * Math.log10(p2 / (p_ref * p_ref)));
        } else {
            SPL.push(-100);
        }
    }
    
    return SPL;
}

// Convert spectrum to log scale
function spectrumToLog(spectrum) {
    const ref = 1.0;
    return spectrum.map(S => {
        if (S > 0) {
            return 10 * Math.log10(S / ref);
        } else {
            return -100;
        }
    });
}

// Initial calculation
const initialResult = calculateSpectrum(0.5, 0.8, 10, 1.0);
const initialSPL = spectrumToSPL(initialResult.spectrum, frequencies);
const initialLogSpectrum = spectrumToLog(initialResult.spectrum);
const initialStrouhal = calculateStrouhal(frequencies, 0.5, 0.8);

// Update display
function updateDisplay(params, k, epsilon) {
    document.getElementById('u0Value').textContent = params.u0.toFixed(2);
    document.getElementById('tau0Value').textContent = params.tau0.toExponential(3);
    document.getElementById('omega0Value').textContent = params.omega0.toFixed(1);
    document.getElementById('l0Value').textContent = params.l0.toFixed(4);
    
    const paramsGrid = document.querySelector('.params-grid');
    if (!document.getElementById('kValue')) {
        const kDiv = document.createElement('div');
        kDiv.innerHTML = '<strong>k:</strong> <span id="kValue">-</span> m²/s²';
        paramsGrid.appendChild(kDiv);
    }
    if (!document.getElementById('epsValue')) {
        const epsDiv = document.createElement('div');
        epsDiv.innerHTML = '<strong>ε:</strong> <span id="epsValue">-</span> m²/s³';
        paramsGrid.appendChild(epsDiv);
    }
    
    document.getElementById('kValue').textContent = k.toFixed(2);
    document.getElementById('epsValue').textContent = epsilon.toFixed(2);
}

updateDisplay(initialResult.params, initialResult.k, initialResult.epsilon);

// Chart setup - Spectrum
const ctx1 = document.getElementById('spectrumChart').getContext('2d');

const spectrumChart = new Chart(ctx1, {
    type: 'line',
    data: {
        labels: initialStrouhal,
        datasets: [{
            label: '10·log₁₀(S) [dB re 1 Pa²/Hz]',
            data: initialLogSpectrum,
            borderColor: '#cc5500',
            backgroundColor: '#cc5500',
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                type: 'logarithmic',
                title: { display: true, text: 'Strouhal Number St = fD/U', font: { size: 14 } },
                min: 0.01,
                max: 100
            },
            y: {
                title: { display: true, text: '10·log₁₀(S) [dB re 1 Pa²/Hz]', font: { size: 14 } }
            }
        },
        plugins: {
            legend: { display: true, position: 'top' },
            title: {
                display: true,
                text: 'Pressure Spectral Density (Log Scale)',
                font: { size: 16, weight: 'bold' }
            }
        }
    }
});

// Chart setup - SPL
const ctx2 = document.getElementById('splChart').getContext('2d');

const splChart = new Chart(ctx2, {
    type: 'line',
    data: {
        labels: initialStrouhal,
        datasets: [{
            label: 'SPL [dB re 20 μPa]',
            data: initialSPL,
            borderColor: '#0066cc',
            backgroundColor: '#0066cc',
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                type: 'logarithmic',
                title: { display: true, text: 'Strouhal Number St = fD/U', font: { size: 14 } },
                min: 0.01,
                max: 100
            },
            y: {
                title: { display: true, text: 'SPL [dB re 20 μPa]', font: { size: 14 } }
            }
        },
        plugins: {
            legend: { display: true, position: 'top' },
            title: {
                display: true,
                text: 'Sound Pressure Level',
                font: { size: 16, weight: 'bold' }
            }
        }
    }
});

// Update function
function updatePlot() {
    const D = parseFloat(sliderD.value);
    const M = parseFloat(sliderM.value);
    const x = parseFloat(sliderX.value);
    const A = parseFloat(sliderA.value);
    
    valD.textContent = D.toFixed(2);
    valM.textContent = M.toFixed(2);
    valX.textContent = x.toFixed(1);
    valA.textContent = A.toFixed(2);
    
    const result = calculateSpectrum(D, M, x, A);
    const SPL = spectrumToSPL(result.spectrum, frequencies);
    const logSpectrum = spectrumToLog(result.spectrum);
    const strouhal = calculateStrouhal(frequencies, D, M);
    
    updateDisplay(result.params, result.k, result.epsilon);
    
    spectrumChart.data.labels = strouhal;
    spectrumChart.data.datasets[0].data = logSpectrum;
    spectrumChart.update('none');
    
    splChart.data.labels = strouhal;
    splChart.data.datasets[0].data = SPL;
    splChart.update('none');
}

sliderD.oninput = updatePlot;
sliderM.oninput = updatePlot;
sliderX.oninput = updatePlot;
sliderA.oninput = updatePlot;
</script>
</body>
</html>
